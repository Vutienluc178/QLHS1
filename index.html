<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Qu·∫£n L√Ω H·ªçc Sinh - Ho√†n Thi·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
        .success-animation { animation: successPulse 0.6s ease-out; }
        @keyframes successPulse { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .notification-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chart-container { position: relative; height: 300px; }
        .metric-card { background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); }
        .print-hidden { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-hidden { display: block !important; }
            .print-break { page-break-after: always; }
        }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .data-table { font-size: 0.875rem; }
        .export-button { transition: all 0.2s ease; }
        .export-button:hover { transform: translateY(-1px); }
        .subject-tab.active { border-bottom-color: #667eea; color: #667eea; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <h1 class="text-xl font-bold">Qu·∫£n L√Ω H·ªçc Sinh L·ªõp 10A1</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="text-white hover:text-gray-200" onclick="showNotifications()">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center notification-badge">3</span>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <img src="https://placehold.co/32x32/f0f0f0/333?text=GV" alt="Avatar" class="w-8 h-8 rounded-full">
                        <span class="font-medium">Th·∫ßy V≈© Ti·∫øn L·ª±c</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm border-b no-print">
        <div class="container mx-auto px-4">
            <div id="main-nav" class="flex space-x-8">
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('dashboard', this)">
                    <i class="fas fa-chart-line mr-2"></i>T·ªïng Quan
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('students', this)">
                    <i class="fas fa-users mr-2"></i>Danh S√°ch H·ªçc Sinh
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('grades', this)">
                    <i class="fas fa-book mr-2"></i>Qu·∫£n L√Ω ƒêi·ªÉm
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('discipline', this)">
                    <i class="fas fa-clipboard-check mr-2"></i>N·ªÅ N·∫øp
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('attendance', this)">
                    <i class="fas fa-calendar-check mr-2"></i>ƒêi·ªÉm Danh
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('communication', this)">
                    <i class="fas fa-comments mr-2"></i>Li√™n L·∫°c
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('reports', this)">
                    <i class="fas fa-chart-bar mr-2"></i>B√°o C√°o & Th·ªëng K√™
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">T·ªïng Quan L·ªõp 10A1</h3>
                        <p class="text-gray-600">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdateTime"></span></p>
                    </div>
                    <button onclick="syncAllData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>L√†m m·ªõi
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">T·ªïng H·ªçc Sinh</p>
                    <p class="text-3xl font-bold text-blue-600" id="dashboardTotalStudents">0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">ƒêi·ªÉm TB L·ªõp</p>
                    <p class="text-3xl font-bold text-green-600" id="dashboardClassAverage">0.0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">T·ª∑ L·ªá Chuy√™n C·∫ßn</p>
                    <p class="text-3xl font-bold text-purple-600" id="dashboardAttendanceRate">0%</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">ƒêi·ªÉm N·ªÅ N·∫øp TB</p>
                    <p class="text-3xl font-bold text-orange-600" id="dashboardDisciplineAverage">0.0</p>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Qu·∫£n L√Ω Danh S√°ch H·ªçc Sinh</h3>
                    <div class="flex space-x-2">
                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onclick="showModal('importModal')"><i class="fas fa-file-excel mr-2"></i>Nh·∫≠p t·ª´ Excel</button>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="exportStudentsToExcel()"><i class="fas fa-download mr-2"></i>Xu·∫•t Excel</button>
                        <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" onclick="showAddStudentModal()"><i class="fas fa-plus mr-2"></i>Th√™m H·ªçc Sinh</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">T√¨m ki·∫øm</label>
                        <div class="relative"><input type="text" id="studentSearch" placeholder="T√™n, SBD..." class="w-full border rounded-lg px-3 py-2 pl-10" onkeyup="filterStudents()"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Gi·ªõi t√≠nh</label>
                        <select id="genderFilter" class="w-full border rounded-lg px-3 py-2" onchange="filterStudents()"><option value="">T·∫•t c·∫£</option><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">X·∫øp lo·∫°i</label>
                        <select id="gradeFilter" class="w-full border rounded-lg px-3 py-2" onchange="filterStudents()"><option value="">T·∫•t c·∫£</option><option value="Xu·∫•t s·∫Øc">Xu·∫•t s·∫Øc</option><option value="Gi·ªèi">Gi·ªèi</option><option value="Kh√°">Kh√°</option><option value="Trung b√¨nh">Trung b√¨nh</option><option value="Y·∫øu">Y·∫øu</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">S·∫Øp x·∫øp</label>
                        <select id="sortOrder" class="w-full border rounded-lg px-3 py-2" onchange="sortStudents()"><option value="name_asc">T√™n A-Z</option><option value="name_desc">T√™n Z-A</option><option value="grade_desc">ƒêi·ªÉm cao-th·∫•p</option><option value="grade_asc">ƒêi·ªÉm th·∫•p-cao</option></select>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H·ªç v√† T√™n</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SBD</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gi·ªõi T√≠nh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm TB</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">X·∫øp Lo·∫°i</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao T√°c</th></tr></thead><tbody id="studentsTableBody" class="divide-y divide-gray-200"></tbody></table>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t"><span class="text-sm text-gray-700">T·ªïng s·ªë <span id="totalStudentsDisplay">0</span> h·ªçc sinh</span></div>
            </div>
        </div>

        <!-- Grades Tab -->
        <div id="grades" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Qu·∫£n L√Ω ƒêi·ªÉm S·ªë</h3>
                    <div class="flex space-x-2">
                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onclick="showBulkGradeModal()"><i class="fas fa-plus mr-2"></i>Nh·∫≠p ƒêi·ªÉm H√†ng Lo·∫°t</button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b"><nav class="flex space-x-8 px-6" id="subject-nav"></nav></div>
                <div class="p-6">
                    <h4 class="text-lg font-semibold mb-4" id="currentSubjectTitle"></h4>
                    <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm S·ªë</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm TB M√¥n</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao T√°c</th></tr></thead><tbody id="gradesTableBody" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- Discipline Tab -->
        <div id="discipline" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">Qu·∫£n L√Ω N·ªÅ N·∫øp</h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm N·ªÅ N·∫øp</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">X·∫øp Lo·∫°i</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khen Th∆∞·ªüng</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vi Ph·∫°m</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao T√°c</th></tr></thead><tbody id="disciplineTableBody" class="divide-y divide-gray-200"></tbody></table></div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">ƒêi·ªÉm Danh H√†ng Ng√†y</h3>
                <div class="flex items-center space-x-4 mb-4">
                    <label for="attendanceDate" class="font-medium">Ch·ªçn ng√†y:</label>
                    <input type="date" id="attendanceDate" class="border rounded-lg px-3 py-2">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="loadAttendanceTable()">T·∫£i danh s√°ch</button>
                </div>
            </div>
            <div id="attendanceSheet" class="hidden bg-white rounded-lg shadow-md p-6">
                 <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng Th√°i</th></tr></thead><tbody id="attendanceTableBody" class="divide-y divide-gray-200"></tbody></table></div>
                 <div class="flex justify-end mt-6">
                     <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700" onclick="saveAttendance()">L∆∞u ƒêi·ªÉm Danh</button>
                 </div>
            </div>
        </div>
        
        <!-- Communication Tab -->
        <div id="communication" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Nh·∫≠t K√Ω Li√™n L·∫°c Ph·ª• Huynh</h3>
                <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" onclick="showModal('addCommLogModal')"><i class="fas fa-plus mr-2"></i>Th√™m Nh·∫≠t K√Ω</button>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h4 class="text-lg font-semibold mb-4">L·ªãch s·ª≠ li√™n l·∫°c</h4>
                <div id="commLogContainer" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold">B√°o C√°o & Th·ªëng K√™</h3>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">T·ªïng H·ªçc Sinh</p>
                    <p class="text-3xl font-bold text-blue-600" id="reportTotalStudents">0</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">ƒêi·ªÉm TB L·ªõp</p>
                    <p class="text-3xl font-bold text-green-600" id="reportClassAverage">0.0</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">T·ª∑ L·ªá Chuy√™n C·∫ßn</p>
                    <p class="text-3xl font-bold text-purple-600" id="reportAttendanceRate">0%</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">ƒêi·ªÉm N·ªÅ N·∫øp TB</p>
                    <p class="text-3xl font-bold text-orange-600" id="reportDisciplineAverage">0.0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Ph√¢n B·ªë X·∫øp Lo·∫°i H·ªçc L·ª±c</h3>
                    <div class="chart-container"><canvas id="distributionChart"></canvas></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Ph√¢n B·ªë X·∫øp Lo·∫°i N·ªÅ N·∫øp</h3>
                    <div class="chart-container"><canvas id="disciplineChart"></canvas></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Top 5 H·ªçc Sinh Xu·∫•t S·∫Øc</h3>
                    <div class="overflow-x-auto"><table class="w-full data-table"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">H·∫°ng</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm TB</th></tr></thead><tbody id="topPerformersTable" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4"><i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>H·ªçc Sinh C·∫ßn H·ªó Tr·ª£</h3>
                    <div class="overflow-x-auto"><table class="w-full data-table"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">V·∫•n ƒê·ªÅ</th></tr></thead><tbody id="supportNeededTable" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
             <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold"><i class="fas fa-user text-indigo-500 mr-2"></i>B√°o C√°o C√° Nh√¢n Chi Ti·∫øt</h3>
                    <select id="individualStudentSelect" class="border rounded-lg px-3 py-2" onchange="loadIndividualReport()"><option value="">Ch·ªçn h·ªçc sinh</option></select>
                </div>
                <div id="individualReportContent" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Th√™m H·ªçc Sinh M·ªõi</h3><button onclick="closeModal('addStudentModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addStudentForm" onsubmit="addNewStudent(event)"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">H·ªç v√† t√™n *</label><input type="text" id="studentName" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">S·ªë b√°o danh *</label><input type="text" id="studentId" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Gi·ªõi t√≠nh *</label><select id="studentGender" required class="w-full border rounded-lg px-3 py-2"><option value="">Ch·ªçn gi·ªõi t√≠nh</option><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div><div><label class="block text-sm font-medium mb-2">Ng√†y sinh *</label><input type="date" id="studentBirthdate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('addStudentModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Th√™m</button></div></form></div></div>
    <div id="editStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Ch·ªânh S·ª≠a Th√¥ng Tin</h3><button onclick="closeModal('editStudentModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="editStudentForm" onsubmit="updateStudent(event)"><input type="hidden" id="editStudentIndex"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">H·ªç v√† t√™n *</label><input type="text" id="editStudentName" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">S·ªë b√°o danh *</label><input type="text" id="editStudentId" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Gi·ªõi t√≠nh *</label><select id="editStudentGender" required class="w-full border rounded-lg px-3 py-2"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div><div><label class="block text-sm font-medium mb-2">Ng√†y sinh *</label><input type="date" id="editStudentBirthdate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('editStudentModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">C·∫≠p Nh·∫≠t</button></div></form></div></div>
    <div id="addGradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Th√™m/S·ª≠a ƒêi·ªÉm</h3><button onclick="closeModal('addGradeModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addGradeForm" onsubmit="addGrade(event)"><input type="hidden" id="gradeStudentId"><input type="hidden" id="gradeSubject"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">ƒêi·ªÉm s·ªë m·ªõi *</label><input type="number" id="gradeValue" min="0" max="10" step="0.1" required class="w-full border rounded-lg px-3 py-2" placeholder="0.0 - 10.0"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addGradeModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Th√™m ƒêi·ªÉm</button></div></form></div></div>
    <div id="bulkGradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Nh·∫≠p ƒêi·ªÉm H√†ng Lo·∫°t</h3><button onclick="closeModal('bulkGradeModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H·ªçc Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm M·ªõi</th></tr></thead><tbody id="bulkGradeTableBody" class="divide-y divide-gray-200"></tbody></table></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('bulkGradeModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button onclick="saveBulkGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">L∆∞u T·∫•t C·∫£</button></div></div></div>
    <div id="addRewardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-green-700"><i class="fas fa-trophy mr-2"></i>Th√™m Khen Th∆∞·ªüng</h3><button onclick="closeModal('addRewardModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addRewardForm" onsubmit="addReward(event)"><input type="hidden" id="rewardStudentId"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">N·ªôi dung khen th∆∞·ªüng *</label><input type="text" id="rewardDescription" required class="w-full border rounded-lg px-3 py-2" placeholder="VD: ƒê·∫°t ƒëi·ªÉm 10 m√¥n To√°n"></div><div><label class="block text-sm font-medium mb-2">ƒêi·ªÉm c·ªông *</label><input type="number" id="rewardPoints" step="0.5" min="0" max="2" value="1" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addRewardModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Th√™m</button></div></form></div></div>
    <div id="addViolationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Ghi Nh·∫≠n Vi Ph·∫°m</h3><button onclick="closeModal('addViolationModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addViolationForm" onsubmit="addViolation(event)"><input type="hidden" id="violationStudentId"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">N·ªôi dung vi ph·∫°m *</label><input type="text" id="violationDescription" required class="w-full border rounded-lg px-3 py-2" placeholder="VD: ƒêi h·ªçc mu·ªôn"></div><div><label class="block text-sm font-medium mb-2">ƒêi·ªÉm tr·ª´ *</label><input type="number" id="violationPoints" step="0.5" min="0.5" max="3" value="1" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addViolationModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Ghi nh·∫≠n</button></div></form></div></div>
    <div id="addCommLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Th√™m Nh·∫≠t K√Ω Li√™n L·∫°c</h3><button onclick="closeModal('addCommLogModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addCommLogForm" onsubmit="addCommLog(event)"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">H·ªçc sinh *</label><select id="commStudentSelect" required class="w-full border rounded-lg px-3 py-2"></select></div><div><label class="block text-sm font-medium mb-2">N·ªôi dung *</label><textarea id="commContent" required class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="VD: Trao ƒë·ªïi v·ªõi ph·ª• huynh v·ªÅ t√¨nh h√¨nh h·ªçc t·∫≠p..."></textarea></div><div><label class="block text-sm font-medium mb-2">Ng√†y li√™n l·∫°c</label><input type="date" id="commDate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addCommLogModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">L∆∞u</button></div></form></div></div>
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 max-w-sm mx-4"><h3 class="text-lg font-semibold mb-4">X√°c nh·∫≠n</h3><p id="confirmationMessage" class="text-gray-600 mb-6"></p><div class="flex justify-end space-x-2"><button id="cancelButton" class="px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button><button id="confirmButton" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">X√°c nh·∫≠n</button></div></div></div>
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><h3 class="text-lg font-semibold mb-4">Nh·∫≠p t·ª´ Excel</h3><p class="text-gray-600 mb-4">Ch·ª©c nƒÉng n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.</p><div class="flex justify-end"><button onclick="closeModal('importModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">ƒê√≥ng</button></div></div></div>
    
    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 success-animation"><div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span id="successMessage"></span></div></div>

    <script>
        /* =======================
         *  A) API CONFIG & HELPERS
         * ======================= */
        // TODO: D√ÅN URL Web App Apps Script c·ªßa th·∫ßy v√†o ƒë√¢y:
        const BASE_URL = 'https://script.google.com/macros/s/AKfycbxr-RiVjkEvJ1DhHtJ8x8sdR7l8-KVaXPWqYLCguraHsTwzj97PP2X5tCRvOPtrBv9P/exec';
        // N·∫øu c√≥ d√πng token trong Code.gs th√¨ ƒë·∫∑t gi·ªëng nhau; n·∫øu kh√¥ng d√πng, ƒë·ªÉ chu·ªói r·ªóng ''
        const API_TOKEN = 'changeme-optional';

        async function apiGet(action, params = {}) {
            const q = new URLSearchParams({ action, token: API_TOKEN, ...params });
            const res = await fetch(`${BASE_URL}?${q.toString()}`);
            return res.json();
        }
        async function apiPost(action, payload = {}) {
            const res = await fetch(BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, token: API_TOKEN, ...payload })
            });
            return res.json();
        }

        async function loadStudentsFromSheet() {
            try {
                const resp = await apiGet('getStudents');
                if (resp.ok && resp.data && Array.isArray(resp.data.students)) {
                    studentsData = resp.data.students;
                    filteredStudents = [...studentsData];
                } else {
                    showSuccessToast('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Sheets. D√πng d·ªØ li·ªáu m·∫´u.');
                }
            } catch (e) {
                console.error(e);
                showSuccessToast('L·ªói k·∫øt n·ªëi Sheets. D√πng d·ªØ li·ªáu m·∫´u.');
            }
        }

        // --- DATA (m·∫´u; s·∫Ω b·ªã thay b·ªüi Sheets n·∫øu load th√†nh c√¥ng) ---
        let studentsData = [
            { id: 1, name: 'Nguy·ªÖn VƒÉn An', studentId: 'HS001', birthdate: '2008-03-15', gender: 'Nam', grades: { math: [8.5, 9], literature: [8], english: [7.5], physics: [8], chemistry: [7.5] }, disciplineScore: 9.5, violations: [{ desc: 'ƒêi mu·ªôn', points: 0.5 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 2, name: 'Tr·∫ßn Th·ªã B√¨nh', studentId: 'HS002', birthdate: '2008-07-22', gender: 'N·ªØ', grades: { math: [7], literature: [8], english: [6.5], physics: [7], chemistry: [6.5] }, disciplineScore: 8, violations: [{ desc: 'Kh√¥ng l√†m BTVN', points: 1 }, { desc: 'N√≥i chuy·ªán ri√™ng', points: 1 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'absent_unexcused' }, communication: [] },
            { id: 3, name: 'L√™ VƒÉn C∆∞·ªùng', studentId: 'HS003', birthdate: '2008-11-10', gender: 'Nam', grades: { math: [9, 9.5], literature: [8.5], english: [8], physics: [9], chemistry: [8.5] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'H·ªçc sinh xu·∫•t s·∫Øc', points: 1 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 4, name: 'Ph·∫°m Th·ªã Dung', studentId: 'HS004', birthdate: '2008-09-05', gender: 'N·ªØ', grades: { math: [8], literature: [9], english: [7.8], physics: [7.5], chemistry: [8.2] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'T√≠ch c·ª±c ph√°t bi·ªÉu', points: 1 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 5, name: 'Ho√†ng VƒÉn Em', studentId: 'HS005', birthdate: '2008-12-18', gender: 'Nam', grades: { math: [6.5], literature: [7.5], english: [6], physics: [6.8], chemistry: [6.5] }, disciplineScore: 9, violations: [{ desc: 'ƒêi mu·ªôn', points: 1 }], rewards: [], attendance: { '2025-05-01': 'late', '2025-05-02': 'present' }, communication: [] },
            { id: 6, name: 'V≈© Th·ªã Giang', studentId: 'HS006', birthdate: '2008-04-30', gender: 'N·ªØ', grades: { math: [9.2, 9.5], literature: [8.8], english: [8.5], physics: [9], chemistry: [9.1] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'Gi·∫£i nh·∫•t thi HSG', points: 2 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 7, name: 'ƒê·ªó VƒÉn H√πng', studentId: 'HS007', birthdate: '2008-06-12', gender: 'Nam', grades: { math: [5.5], literature: [6], english: [4.5], physics: [5], chemistry: [5.2] }, disciplineScore: 6.5, violations: [{ desc: 'Ngh·ªâ kh√¥ng ph√©p', points: 2 }, { desc: 'G√¢y m·∫•t tr·∫≠t t·ª±', points: 1.5 }], rewards: [], attendance: { '2025-05-01': 'absent_unexcused', '2025-05-02': 'absent_unexcused' }, communication: [] },
            { id: 8, name: 'B√πi Th·ªã H∆∞∆°ng', studentId: 'HS008', birthdate: '2008-08-25', gender: 'N·ªØ', grades: { math: [7.8], literature: [8.5], english: [7.2], physics: [7.5], chemistry: [7.8] }, disciplineScore: 10, violations: [], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 9, name: 'L√Ω VƒÉn Kh√°nh', studentId: 'HS009', birthdate: '2008-01-08', gender: 'Nam', grades: { math: [8.8], literature: [8.2], english: [8], physics: [8.5], chemistry: [8.3] }, disciplineScore: 9.5, violations: [], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'absent_excused' }, communication: [] },
            { id: 10, name: 'Ng√¥ Th·ªã Linh', studentId: 'HS010', birthdate: '2008-10-14', gender: 'N·ªØ', grades: { math: [6.8], literature: [7.5], english: [6.5], physics: [6.8], chemistry: [7] }, disciplineScore: 9, violations: [{ desc: 'Qu√™n ƒë·ªìng ph·ª•c', points: 1 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] }
        ];
        const subjectMap = { math: 'To√°n', literature: 'Ng·ªØ vƒÉn', english: 'Ti·∫øng Anh', physics: 'V·∫≠t l√Ω', chemistry: 'H√≥a h·ªçc' };

        // --- GLOBAL STATE ---
        let filteredStudents = [...studentsData];
        let currentSubject = 'math';
        let chartInstances = {};

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async function() {
            showTab('dashboard', document.querySelector('#main-nav button'));
            document.getElementById('attendanceDate').valueAsDate = new Date();
            document.getElementById('commDate').valueAsDate = new Date();
            initializeSubjectTabs();
            initializeCharts();

            // üîó T·∫£i d·ªØ li·ªáu th·∫≠t t·ª´ Google Sheets (n·∫øu th√†nh c√¥ng s·∫Ω ghi ƒë√® d·ªØ li·ªáu m·∫´u)
            await loadStudentsFromSheet();
            syncAllData();
        });

        // --- CORE SYNC & UTILITY FUNCTIONS ---
        function syncAllData() {
            console.log("Syncing all application data...");
            updateLastUpdateTime();
            filterStudents(); 
            updateDashboardMetrics();
            updateReportMetrics();
            loadReportTables();
            populateIndividualStudentSelect();
            loadGradesTable();
            populateCommStudentSelect();
            loadDisciplineTable();
            loadCommLogs();
            updateAllCharts();
            console.log("Sync complete.");
        }

        function calculateSubjectAverage(grades) {
            if (!grades || grades.length === 0) return 0;
            return grades.reduce((a, b) => a + b, 0) / grades.length;
        }

        function calculateOverallAverage(student) {
            const subjectAvgs = Object.values(student.grades).map(calculateSubjectAverage).filter(avg => avg > 0);
            if (subjectAvgs.length === 0) return 0;
            return subjectAvgs.reduce((a, b) => a + b, 0) / subjectAvgs.length;
        }

        function getClassification(average) {
            if (average >= 9) return 'Xu·∫•t s·∫Øc';
            if (average >= 8) return 'Gi·ªèi';
            if (average >= 6.5) return 'Kh√°';
            if (average >= 5) return 'Trung b√¨nh';
            return 'Y·∫øu';
        }

        function getDisciplineClassification(score) {
            if (score >= 9.5) return 'T·ªët';
            if (score >= 8) return 'Kh√°';
            if (score >= 6.5) return 'Trung b√¨nh';
            return 'Y·∫øu';
        }

        function showSuccessToast(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }

        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationMessage').textContent = message;
            const confirmButton = document.getElementById('confirmButton');
            document.getElementById('cancelButton').onclick = () => closeModal('confirmationModal');
            confirmButton.onclick = () => { onConfirm(); closeModal('confirmationModal'); };
            modal.classList.remove('hidden');
        }

        // --- UI & TAB MANAGEMENT ---
        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.remove('tab-active'));
            element.classList.add('tab-active');
        }

        function initializeSubjectTabs() {
            const nav = document.getElementById('subject-nav');
            nav.innerHTML = '';
            Object.keys(subjectMap).forEach((key, index) => {
                const button = document.createElement('button');
                button.className = `py-4 px-2 border-b-2 font-medium subject-tab ${index === 0 ? 'active' : 'border-transparent text-gray-500'}`;
                button.textContent = subjectMap[key];
                button.onclick = () => showSubjectGrades(key);
                button.dataset.subject = key;
                nav.appendChild(button);
            });
        }

        function showSubjectGrades(subjectKey) {
            currentSubject = subjectKey;
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.subject === subjectKey);
                tab.classList.toggle('border-transparent', tab.dataset.subject !== subjectKey);
                tab.classList.toggle('text-gray-500', tab.dataset.subject !== subjectKey);
            });
            document.getElementById('currentSubjectTitle').textContent = `B·∫£ng ƒêi·ªÉm M√¥n ${subjectMap[subjectKey]}`;
            loadGradesTable();
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('vi-VN');
        }
        
        function showModal(modalId) {
             document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- CHART MANAGEMENT ---
        function createChart(elementId, type, data, options) {
            const ctx = document.getElementById(elementId).getContext('2d');
            if (chartInstances[elementId]) chartInstances[elementId].destroy();
            chartInstances[elementId] = new Chart(ctx, { type, data, options });
        }

        function initializeCharts() {
            const commonPieOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
            createChart('distributionChart', 'doughnut', { labels: [], datasets: [{ data: [], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#F97316', '#EF4444'] }] }, commonPieOptions);
            createChart('disciplineChart', 'pie', { labels: [], datasets: [{ data: [], backgroundColor: ['#22C55E', '#8B5CF6', '#F59E0B', '#EF4444'] }] }, commonPieOptions);
        }

        function updateAllCharts() {
            const gradeDistData = { 'Xu·∫•t s·∫Øc': 0, 'Gi·ªèi': 0, 'Kh√°': 0, 'Trung b√¨nh': 0, 'Y·∫øu': 0 };
            studentsData.forEach(s => gradeDistData[getClassification(calculateOverallAverage(s))]++);
            chartInstances['distributionChart'].data.labels = Object.keys(gradeDistData);
            chartInstances['distributionChart'].data.datasets[0].data = Object.values(gradeDistData);
            chartInstances['distributionChart'].update();
            
            const discDistData = { 'T·ªët': 0, 'Kh√°': 0, 'Trung b√¨nh': 0, 'Y·∫øu': 0 };
            studentsData.forEach(s => discDistData[getDisciplineClassification(s.disciplineScore)]++);
            chartInstances['disciplineChart'].data.labels = Object.keys(discDistData);
            chartInstances['disciplineChart'].data.datasets[0].data = Object.values(discDistData);
            chartInstances['disciplineChart'].update();
        }

        // --- STUDENT MANAGEMENT ---
        function loadStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            filteredStudents.forEach((student, index) => {
                const avg = calculateOverallAverage(student);
                const classification = getClassification(avg);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${student.name}</td>
                    <td class="px-4 py-3">${student.studentId}</td>
                    <td class="px-4 py-3">${student.gender}</td>
                    <td class="px-4 py-3 font-bold">${avg.toFixed(1)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded-full">${classification}</span></td>
                    <td class="px-4 py-3"><div class="flex space-x-2">
                        <button onclick="showEditStudentModal(${student.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteStudent(${student.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                    </div></td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('totalStudentsDisplay').textContent = filteredStudents.length;
        }

        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const genderFilter = document.getElementById('genderFilter').value;
            const gradeFilter = document.getElementById('gradeFilter').value;
            filteredStudents = studentsData.filter(s => 
                (!genderFilter || s.gender === genderFilter) &&
                (!gradeFilter || getClassification(calculateOverallAverage(s)) === gradeFilter) &&
                (s.name.toLowerCase().includes(searchTerm) || s.studentId.toLowerCase().includes(searchTerm))
            );
            sortStudents();
        }

        function sortStudents() {
            const sortOrder = document.getElementById('sortOrder').value;
            filteredStudents.sort((a, b) => {
                switch(sortOrder) {
                    case 'name_desc': return b.name.localeCompare(a.name);
                    case 'grade_desc': return calculateOverallAverage(b) - calculateOverallAverage(a);
                    case 'grade_asc': return calculateOverallAverage(a) - calculateOverallAverage(b);
                    default: return a.name.localeCompare(b.name);
                }
            });
            loadStudentsTable();
        }

        function showAddStudentModal() {
            document.getElementById('addStudentForm').reset();
            showModal('addStudentModal');
        }

        // üîó GH√âP API: th√™m m·ªõi h·ªçc sinh (ghi Sheets)
        async function addNewStudent(event) {
            event.preventDefault();
            const newStudent = {
                id: Date.now(),
                name: document.getElementById('studentName').value,
                studentId: document.getElementById('studentId').value,
                gender: document.getElementById('studentGender').value,
                birthdate: document.getElementById('studentBirthdate').value,
                grades: Object.keys(subjectMap).reduce((acc, key) => ({...acc, [key]: [] }), {}),
                disciplineScore: 10, violations: [], rewards: [], attendance: {}, communication: []
            };
            const resp = await apiPost('upsertStudent', { student: newStudent });
            if (resp.ok) {
                closeModal('addStudentModal');
                showSuccessToast('ƒê√£ th√™m h·ªçc sinh m·ªõi!');
                await loadStudentsFromSheet();
                syncAllData();
            } else {
                showSuccessToast('L·ªói khi th√™m h·ªçc sinh');
            }
        }

        function showEditStudentModal(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            document.getElementById('editStudentIndex').value = student.id;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentId').value = student.studentId;
            document.getElementById('editStudentGender').value = student.gender;
            document.getElementById('editStudentBirthdate').value = student.birthdate;
            showModal('editStudentModal');
        }

        // üîó GH√âP API: c·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh
        async function updateStudent(event) {
            event.preventDefault();
            const studentId = parseInt(document.getElementById('editStudentIndex').value);
            const student = studentsData.find(s => s.id === studentId);
            if (student) {
                student.name = document.getElementById('editStudentName').value;
                student.studentId = document.getElementById('editStudentId').value;
                student.gender = document.getElementById('editStudentGender').value;
                student.birthdate = document.getElementById('editStudentBirthdate').value;

                const resp = await apiPost('upsertStudent', { student });
                if (resp.ok) {
                    closeModal('editStudentModal');
                    showSuccessToast('ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!');
                    await loadStudentsFromSheet();
                    syncAllData();
                } else {
                    showSuccessToast('L·ªói khi c·∫≠p nh·∫≠t!');
                }
            }
        }
        
        // üîó GH√âP API: x√≥a h·ªçc sinh
        function confirmDeleteStudent(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            showConfirmation(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh ${student.name}?`, async () => {
                const resp = await apiPost('deleteStudent', { id: studentId });
                if (resp.ok) {
                    showSuccessToast('ƒê√£ x√≥a h·ªçc sinh!');
                    await loadStudentsFromSheet();
                    syncAllData();
                } else {
                    showSuccessToast('X√≥a th·∫•t b·∫°i!');
                }
            });
        }
        
        // --- GRADES MANAGEMENT ---
        function loadGradesTable() {
            const tbody = document.getElementById('gradesTableBody');
            tbody.innerHTML = '';
            studentsData.forEach((student, index) => {
                const subjectGrades = student.grades[currentSubject] || [];
                const avg = calculateSubjectAverage(subjectGrades);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${student.name}</td>
                    <td class="px-4 py-3">${subjectGrades.join(', ') || 'Ch∆∞a c√≥ ƒëi·ªÉm'}</td>
                    <td class="px-4 py-3 font-bold">${avg > 0 ? avg.toFixed(1) : '-'}</td>
                    <td class="px-4 py-3"><button onclick="showAddGradeModal(${student.id}, '${currentSubject}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddGradeModal(studentId, subject) {
            document.getElementById('addGradeForm').reset();
            document.getElementById('gradeStudentId').value = studentId;
            document.getElementById('gradeSubject').value = subject;
            showModal('addGradeModal');
        }

        // üîó GH√âP API: th√™m ƒëi·ªÉm m·ªôt m√¥n
        async function addGrade(event) {
            event.preventDefault();
            const studentId = parseInt(document.getElementById('gradeStudentId').value);
            const subject = document.getElementById('gradeSubject').value;
            const grade = parseFloat(document.getElementById('gradeValue').value);
            if (isNaN(grade)) return;

            const resp = await apiPost('addGrade', { id: studentId, subject, value: grade });
            if (resp.ok) {
                closeModal('addGradeModal');
                showSuccessToast('ƒê√£ th√™m ƒëi·ªÉm th√†nh c√¥ng!');
                await loadStudentsFromSheet();
                syncAllData();
            } else {
                showSuccessToast('L·ªói th√™m ƒëi·ªÉm!');
            }
        }

        function showBulkGradeModal() {
            loadBulkGradeTable();
            showModal('bulkGradeModal');
        }

        function loadBulkGradeTable() {
            const tbody = document.getElementById('bulkGradeTableBody');
            tbody.innerHTML = '';
            studentsData.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${student.name}</td>
                    <td class="px-4 py-3">
                        <input type="number" min="0" max="10" step="0.1" 
                               class="w-full border rounded px-2 py-1 bulk-grade-input" 
                               data-student-id="${student.id}" placeholder="0.0-10.0">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // L∆∞u ƒëi·ªÉm h√†ng lo·∫°t (g·ªçi API theo t·ª´ng em)
        async function saveBulkGrades() {
            const gradeInputs = document.querySelectorAll('.bulk-grade-input');
            let addedCount = 0;
            for (const input of gradeInputs) {
                const studentId = parseInt(input.dataset.studentId);
                const gradeValue = parseFloat(input.value);
                if (!isNaN(gradeValue)) {
                    const resp = await apiPost('addGrade', { id: studentId, subject: currentSubject, value: gradeValue });
                    if (resp.ok) addedCount++;
                }
            }
            if (addedCount > 0) {
                closeModal('bulkGradeModal');
                showSuccessToast(`ƒê√£ th√™m ƒëi·ªÉm cho ${addedCount} h·ªçc sinh!`);
                await loadStudentsFromSheet();
                syncAllData();
            } else {
                showSuccessToast('Kh√¥ng c√≥ ƒëi·ªÉm n√†o h·ª£p l·ªá ƒë∆∞·ª£c nh·∫≠p.');
            }
        }
        
        // --- DISCIPLINE MANAGEMENT ---
        function loadDisciplineTable() {
            const tbody = document.getElementById('disciplineTableBody');
            tbody.innerHTML = '';
            studentsData.forEach((student, index) => {
                const classification = getDisciplineClassification(student.disciplineScore);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${student.name}</td>
                    <td class="px-4 py-3 font-bold">${student.disciplineScore.toFixed(1)}</td>
                    <td class="px-4 py-3">${classification}</td>
                    <td class="px-4 py-3">${student.rewards.length}</td>
                    <td class="px-4 py-3">${student.violations.length}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="showAddRewardModal(${student.id})" class="text-green-600 hover:text-green-800"><i class="fas fa-plus"></i></button>
                            <button onclick="showAddViolationModal(${student.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-minus"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddRewardModal(studentId) {
            document.getElementById('addRewardForm').reset();
            document.getElementById('rewardStudentId').value = studentId;
            showModal('addRewardModal');
        }

        // üîó GH√âP API: th√™m khen th∆∞·ªüng
        async function addReward(event) {
            event.preventDefault();
            const studentId = parseInt(document.getElementById('rewardStudentId').value);
            const desc = document.getElementById('rewardDescription').value;
            const points = parseFloat(document.getElementById('rewardPoints').value);
            const resp = await apiPost('addReward', { id: studentId, desc, points });
            if (resp.ok) {
                closeModal('addRewardModal');
                showSuccessToast('ƒê√£ th√™m khen th∆∞·ªüng!');
                await loadStudentsFromSheet();
                syncAllData();
            } else {
                showSuccessToast('L·ªói th√™m khen th∆∞·ªüng!');
            }
        }

        function showAddViolationModal(studentId) {
            document.getElementById('addViolationForm').reset();
            document.getElementById('violationStudentId').value = studentId;
            showModal('addViolationModal');
        }

        // üîó GH√âP API: th√™m vi ph·∫°m
        async function addViolation(event) {
            event.preventDefault();
            const studentId = parseInt(document.getElementById('violationStudentId').value);
            const desc = document.getElementById('violationDescription').value;
            const points = parseFloat(document.getElementById('violationPoints').value);
            const resp = await apiPost('addViolation', { id: studentId, desc, points });
            if (resp.ok) {
                closeModal('addViolationModal');
                showSuccessToast('ƒê√£ ghi nh·∫≠n vi ph·∫°m!');
                await loadStudentsFromSheet();
                syncAllData();
            } else {
                showSuccessToast('L·ªói ghi nh·∫≠n vi ph·∫°m!');
            }
        }

        // --- ATTENDANCE & COMMUNICATION ---
        function loadAttendanceTable() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) { showSuccessToast('Vui l√≤ng ch·ªçn ng√†y ƒëi·ªÉm danh.'); return; }
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            studentsData.forEach((student, index) => {
                const status = student.attendance[date] || 'present';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${student.name}</td>
                    <td class="px-4 py-3"><div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="status-${student.id}" value="present" ${status === 'present' ? 'checked' : ''} class="mr-2">C√≥ m·∫∑t</label>
                        <label class="flex items-center"><input type="radio" name="status-${student.id}" value="late" ${status === 'late' ? 'checked' : ''} class="mr-2">ƒêi mu·ªôn</label>
                        <label class="flex items-center"><input type="radio" name="status-${student.id}" value="absent_excused" ${status === 'absent_excused' ? 'checked' : ''} class="mr-2">V·∫Øng c√≥ ph√©p</label>
                        <label class="flex items-center"><input type="radio" name="status-${student.id}" value="absent_unexcused" ${status === 'absent_unexcused' ? 'checked' : ''} class="mr-2">V·∫Øng kh√¥ng ph√©p</label>
                    </div></td>`;
                tbody.appendChild(row);
            });
            document.getElementById('attendanceSheet').classList.remove('hidden');
        }

        // üîó GH√âP API: l∆∞u ƒëi·ªÉm danh (g·ªçi theo t·ª´ng em)
        async function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) return;
            let saved = 0;
            for (const student of studentsData) {
                const statusEl = document.querySelector(`input[name="status-${student.id}"]:checked`);
                if (!statusEl) continue;
                const resp = await apiPost('saveAttendance', { id: student.id, date, status: statusEl.value });
                if (resp.ok) saved++;
            }
            showSuccessToast(`ƒê√£ l∆∞u ƒëi·ªÉm danh ${saved}/${studentsData.length} em!`);
            await loadStudentsFromSheet();
            syncAllData();
        }

        function populateCommStudentSelect() {
            const select = document.getElementById('commStudentSelect');
            select.innerHTML = '<option value="">Ch·ªçn h·ªçc sinh</option>';
            studentsData.forEach(student => select.innerHTML += `<option value="${student.id}">${student.name}</option>`);
        }

        // üîó GH√âP API: l∆∞u nh·∫≠t k√Ω li√™n l·∫°c
        async function addCommLog(event) {
            event.preventDefault();
            const studentId = parseInt(document.getElementById('commStudentSelect').value);
            const student = studentsData.find(s => s.id === studentId);
            if (student) {
                const date = document.getElementById('commDate').value;
                const content = document.getElementById('commContent').value;
                const resp = await apiPost('addCommLog', { id: studentId, date, content });
                if (resp.ok) {
                    closeModal('addCommLogModal');
                    showSuccessToast('ƒê√£ l∆∞u nh·∫≠t k√Ω li√™n l·∫°c!');
                    await loadStudentsFromSheet();
                    syncAllData();
                } else {
                    showSuccessToast('L·ªói l∆∞u nh·∫≠t k√Ω!');
                }
            }
        }

        function loadCommLogs() {
            const container = document.getElementById('commLogContainer');
            container.innerHTML = '';
            let hasLogs = false;
            studentsData.forEach(student => {
                if (student.communication && student.communication.length > 0) {
                    hasLogs = true;
                    student.communication.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-50 rounded-lg border';
                        div.innerHTML = `<p class="font-medium">${student.name} - <span class="text-gray-600">${new Date(log.date).toLocaleDateString('vi-VN')}</span></p><p class="text-sm text-gray-700 mt-1">${log.content}</p>`;
                        container.appendChild(div);
                    });
                }
            });
            if (!hasLogs) container.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ nh·∫≠t k√Ω li√™n l·∫°c n√†o.</p>';
        }

        // --- DASHBOARD & REPORTS ---
        function updateDashboardMetrics() {
            const totalStudents = studentsData.length;
            const classAverage = totalStudents > 0 ? studentsData.reduce((sum, s) => sum + calculateOverallAverage(s), 0) / totalStudents : 0;
            const disciplineAverage = totalStudents > 0 ? studentsData.reduce((sum, s) => sum + s.disciplineScore, 0) / totalStudents : 0;
            
            const totalDays = Object.keys(studentsData.reduce((allDates, s) => ({...allDates, ...s.attendance}), {})).length;
            let totalPresentSessions = 0;
            studentsData.forEach(s => {
                Object.values(s.attendance).forEach(status => {
                    if (status === 'present' || status === 'late') totalPresentSessions++;
                });
            });
            const attendanceRate = (totalDays * totalStudents > 0) ? (totalPresentSessions / (totalDays * totalStudents)) * 100 : 0;

            document.getElementById('dashboardTotalStudents').textContent = totalStudents;
            document.getElementById('dashboardClassAverage').textContent = classAverage.toFixed(1);
            document.getElementById('dashboardAttendanceRate').textContent = attendanceRate.toFixed(1) + '%';
            document.getElementById('dashboardDisciplineAverage').textContent = disciplineAverage.toFixed(1);
        }

        function updateReportMetrics() {
            const totalStudents = studentsData.length;
            const classAverage = totalStudents > 0 ? studentsData.reduce((sum, s) => sum + calculateOverallAverage(s), 0) / totalStudents : 0;
            const disciplineAverage = totalStudents > 0 ? studentsData.reduce((sum, s) => sum + s.disciplineScore, 0) / totalStudents : 0;
            const totalDays = Object.keys(studentsData.reduce((allDates, s) => ({...allDates, ...s.attendance}), {})).length;
            let totalPresentSessions = 0;
            studentsData.forEach(s => {
                Object.values(s.attendance).forEach(status => {
                    if (status === 'present' || status === 'late') totalPresentSessions++;
                });
            });
            const attendanceRate = (totalDays * totalStudents > 0) ? (totalPresentSessions / (totalDays * totalStudents)) * 100 : 0;
            
            document.getElementById('reportTotalStudents').textContent = totalStudents;
            document.getElementById('reportClassAverage').textContent = classAverage.toFixed(1);
            document.getElementById('reportAttendanceRate').textContent = attendanceRate.toFixed(1) + '%';
            document.getElementById('reportDisciplineAverage').textContent = disciplineAverage.toFixed(1);
        }

        function loadReportTables() {
            const topTbody = document.getElementById('topPerformersTable');
            topTbody.innerHTML = '';
            [...studentsData].sort((a,b) => calculateOverallAverage(b) - calculateOverallAverage(a)).slice(0, 5).forEach((s, i) => {
                topTbody.innerHTML += `<tr><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${s.name}</td><td class="px-3 py-2 font-bold">${calculateOverallAverage(s).toFixed(1)}</td></tr>`;
            });

            const supportTbody = document.getElementById('supportNeededTable');
            supportTbody.innerHTML = '';
            studentsData.filter(s => calculateOverallAverage(s) < 6.5 || s.disciplineScore < 8).forEach(s => {
                const issues = [];
                if (calculateOverallAverage(s) < 6.5) issues.push('H·ªçc l·ª±c y·∫øu');
                if (s.disciplineScore < 8) issues.push('N·ªÅ n·∫øp c·∫ßn c·∫£i thi·ªán');
                supportTbody.innerHTML += `<tr><td class="px-3 py-2">${s.name}</td><td class="px-3 py-2">${issues.join(', ')}</td></tr>`;
            });
        }
        
        function populateIndividualStudentSelect() {
            const select = document.getElementById('individualStudentSelect');
            select.innerHTML = '<option value="">Ch·ªçn h·ªçc sinh</option>';
            studentsData.forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`);
        }

        function loadIndividualReport() {
            const studentId = parseInt(document.getElementById('individualStudentSelect').value);
            const content = document.getElementById('individualReportContent');
            const student = studentsData.find(s => s.id === studentId);
            if (!student) {
                content.classList.add('hidden');
                return;
            }
            const avg = calculateOverallAverage(student);
            content.innerHTML = `
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>ƒêi·ªÉm TB h·ªçc t·∫≠p:</strong> <span class="font-bold text-lg text-green-600">${avg.toFixed(1)}</span></p>
                            <p><strong>X·∫øp lo·∫°i h·ªçc l·ª±c:</strong> <span class="font-semibold">${getClassification(avg)}</span></p>
                        </div>
                        <div>
                            <p><strong>ƒêi·ªÉm n·ªÅ n·∫øp:</strong> <span class="font-bold text-lg text-blue-600">${student.disciplineScore.toFixed(1)}</span></p>
                            <p><strong>X·∫øp lo·∫°i n·ªÅ n·∫øp:</strong> <span class="font-semibold">${getDisciplineClassification(student.disciplineScore)}</span></p>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                             <h5 class="font-semibold mb-2">ƒêi·ªÉm chi ti·∫øt c√°c m√¥n:</h5>
                            <ul>${Object.keys(student.grades).map(key => `<li>${subjectMap[key]}: <span class="font-medium">${calculateSubjectAverage(student.grades[key]).toFixed(1)}</span></li>`).join('')}</ul>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2">Vi ph·∫°m:</h5>
                            ${student.violations.length > 0 ? `<ul>${student.violations.map(v => `<li>- ${v.desc} (-${v.points}ƒë)</li>`).join('')}</ul>` : '<p class="text-gray-500">Kh√¥ng c√≥</p>'}
                             <h5 class="font-semibold mt-2 mb-2">Khen th∆∞·ªüng:</h5>
                            ${student.rewards.length > 0 ? `<ul>${student.rewards.map(r => `<li>- ${r.desc} (+${r.points}ƒë)</li>`).join('')}</ul>` : '<p class="text-gray-500">Kh√¥ng c√≥</p>'}
                        </div>
                    </div>
                </div>
            `;
            content.classList.remove('hidden');
        }
        
        // --- STUB FUNCTIONS for unimplemented features ---
        function showNotifications() { showSuccessToast('Ch·ª©c nƒÉng th√¥ng b√°o ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.'); }
        function exportStudentsToExcel() { showSuccessToast('Ch·ª©c nƒÉng xu·∫•t Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.'); }
        function printReport() { window.print(); }

    </script>
</body>
</html>

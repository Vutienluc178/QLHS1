<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Quản Lý Học Sinh - Hoàn Thiện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
        .success-animation { animation: successPulse 0.6s ease-out; }
        @keyframes successPulse { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .notification-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chart-container { position: relative; height: 300px; }
        .metric-card { background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); }
        .print-hidden { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-hidden { display: block !important; }
            .print-break { page-break-after: always; }
        }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .data-table { font-size: 0.875rem; }
        .export-button { transition: all 0.2s ease; }
        .export-button:hover { transform: translateY(-1px); }
        .subject-tab.active { border-bottom-color: #667eea; color: #667eea; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <h1 class="text-xl font-bold">Quản Lý Học Sinh Lớp 10A8 NHC NH 2025-2026</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="text-white hover:text-gray-200" onclick="showNotifications()">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center notification-badge">3</span>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <img src="https://placehold.co/32x32/f0f0f0/333?text=GV" alt="Avatar" class="w-8 h-8 rounded-full">
                        <span class="font-medium">Thầy Vũ Tiến Lực NHC</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm border-b no-print">
        <div class="container mx-auto px-4">
            <div id="main-nav" class="flex space-x-8">
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('dashboard', this)">
                    <i class="fas fa-chart-line mr-2"></i>Tổng Quan
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('students', this)">
                    <i class="fas fa-users mr-2"></i>Danh Sách Học Sinh
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('grades', this)">
                    <i class="fas fa-book mr-2"></i>Quản Lý Điểm
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('discipline', this)">
                    <i class="fas fa-clipboard-check mr-2"></i>Nề Nếp
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('attendance', this)">
                    <i class="fas fa-calendar-check mr-2"></i>Điểm Danh
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('communication', this)">
                    <i class="fas fa-comments mr-2"></i>Liên Lạc
                </button>
                <button class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('reports', this)">
                    <i class="fas fa-chart-bar mr-2"></i>Báo Cáo & Thống Kê
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">Tổng Quan Lớp 10A1</h3>
                        <p class="text-gray-600">Cập nhật lần cuối: <span id="lastUpdateTime"></span></p>
                    </div>
                    <button onclick="syncAllData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Làm mới
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Tổng Học Sinh</p>
                    <p class="text-3xl font-bold text-blue-600" id="dashboardTotalStudents">0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Điểm TB Lớp</p>
                    <p class="text-3xl font-bold text-green-600" id="dashboardClassAverage">0.0</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Tỷ Lệ Chuyên Cần</p>
                    <p class="text-3xl font-bold text-purple-600" id="dashboardAttendanceRate">0%</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Điểm Nề Nếp TB</p>
                    <p class="text-3xl font-bold text-orange-600" id="dashboardDisciplineAverage">0.0</p>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Quản Lý Danh Sách Học Sinh</h3>
                    <div class="flex space-x-2">
                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onclick="showModal('importModal')"><i class="fas fa-file-excel mr-2"></i>Nhập từ Excel</button>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="exportStudentsToExcel()"><i class="fas fa-download mr-2"></i>Xuất Excel</button>
                        <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" onclick="showAddStudentModal()"><i class="fas fa-plus mr-2"></i>Thêm Học Sinh</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tìm kiếm</label>
                        <div class="relative"><input type="text" id="studentSearch" placeholder="Tên, SBD..." class="w-full border rounded-lg px-3 py-2 pl-10" onkeyup="filterStudents()"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Giới tính</label>
                        <select id="genderFilter" class="w-full border rounded-lg px-3 py-2" onchange="filterStudents()"><option value="">Tất cả</option><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Xếp loại</label>
                        <select id="gradeFilter" class="w-full border rounded-lg px-3 py-2" onchange="filterStudents()"><option value="">Tất cả</option><option value="Xuất sắc">Xuất sắc</option><option value="Giỏi">Giỏi</option><option value="Khá">Khá</option><option value="Trung bình">Trung bình</option><option value="Yếu">Yếu</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Sắp xếp</label>
                        <select id="sortOrder" class="w-full border rounded-lg px-3 py-2" onchange="sortStudents()"><option value="name_asc">Tên A-Z</option><option value="name_desc">Tên Z-A</option><option value="grade_desc">Điểm cao-thấp</option><option value="grade_asc">Điểm thấp-cao</option></select>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Họ và Tên</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SBD</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giới Tính</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm TB</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Xếp Loại</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao Tác</th></tr></thead><tbody id="studentsTableBody" class="divide-y divide-gray-200"></tbody></table>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t"><span class="text-sm text-gray-700">Tổng số <span id="totalStudentsDisplay">0</span> học sinh</span></div>
            </div>
        </div>

        <!-- Grades Tab -->
        <div id="grades" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Quản Lý Điểm Số</h3>
                    <div class="flex space-x-2">
                        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onclick="showBulkGradeModal()"><i class="fas fa-plus mr-2"></i>Nhập Điểm Hàng Loạt</button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b"><nav class="flex space-x-8 px-6" id="subject-nav"></nav></div>
                <div class="p-6">
                    <h4 class="text-lg font-semibold mb-4" id="currentSubjectTitle"></h4>
                    <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm Số</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm TB Môn</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao Tác</th></tr></thead><tbody id="gradesTableBody" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- Discipline Tab -->
        <div id="discipline" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">Quản Lý Nề Nếp</h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm Nề Nếp</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Xếp Loại</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khen Thưởng</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vi Phạm</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao Tác</th></tr></thead><tbody id="disciplineTableBody" class="divide-y divide-gray-200"></tbody></table></div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Điểm Danh Hàng Ngày</h3>
                <div class="flex items-center space-x-4 mb-4">
                    <label for="attendanceDate" class="font-medium">Chọn ngày:</label>
                    <input type="date" id="attendanceDate" class="border rounded-lg px-3 py-2">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="loadAttendanceTable()">Tải danh sách</button>
                </div>
            </div>
            <div id="attendanceSheet" class="hidden bg-white rounded-lg shadow-md p-6">
                 <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th></tr></thead><tbody id="attendanceTableBody" class="divide-y divide-gray-200"></tbody></table></div>
                 <div class="flex justify-end mt-6">
                     <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700" onclick="saveAttendance()">Lưu Điểm Danh</button>
                 </div>
            </div>
        </div>
        
        <!-- Communication Tab -->
        <div id="communication" class="tab-content hidden">
             <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Nhật Ký Liên Lạc Phụ Huynh</h3>
                <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" onclick="showModal('addCommLogModal')"><i class="fas fa-plus mr-2"></i>Thêm Nhật Ký</button>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h4 class="text-lg font-semibold mb-4">Lịch sử liên lạc</h4>
                <div id="commLogContainer" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold">Báo Cáo & Thống Kê</h3>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Tổng Học Sinh</p>
                    <p class="text-3xl font-bold text-blue-600" id="reportTotalStudents">0</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Điểm TB Lớp</p>
                    <p class="text-3xl font-bold text-green-600" id="reportClassAverage">0.0</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Tỷ Lệ Chuyên Cần</p>
                    <p class="text-3xl font-bold text-purple-600" id="reportAttendanceRate">0%</p>
                </div>
                <div class="metric-card rounded-lg shadow-md p-6 card-hover">
                    <p class="text-gray-600 text-sm">Điểm Nề Nếp TB</p>
                    <p class="text-3xl font-bold text-orange-600" id="reportDisciplineAverage">0.0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Phân Bố Xếp Loại Học Lực</h3>
                    <div class="chart-container"><canvas id="distributionChart"></canvas></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Phân Bố Xếp Loại Nề Nếp</h3>
                    <div class="chart-container"><canvas id="disciplineChart"></canvas></div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Top 5 Học Sinh Xuất Sắc</h3>
                    <div class="overflow-x-auto"><table class="w-full data-table"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hạng</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Điểm TB</th></tr></thead><tbody id="topPerformersTable" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4"><i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>Học Sinh Cần Hỗ Trợ</h3>
                    <div class="overflow-x-auto"><table class="w-full data-table"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vấn Đề</th></tr></thead><tbody id="supportNeededTable" class="divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
             <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold"><i class="fas fa-user text-indigo-500 mr-2"></i>Báo Cáo Cá Nhân Chi Tiết</h3>
                    <select id="individualStudentSelect" class="border rounded-lg px-3 py-2" onchange="loadIndividualReport()"><option value="">Chọn học sinh</option></select>
                </div>
                <div id="individualReportContent" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Thêm Học Sinh Mới</h3><button onclick="closeModal('addStudentModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addStudentForm" onsubmit="addNewStudent(event)"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">Họ và tên *</label><input type="text" id="studentName" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Số báo danh *</label><input type="text" id="studentId" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Giới tính *</label><select id="studentGender" required class="w-full border rounded-lg px-3 py-2"><option value="">Chọn giới tính</option><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div><div><label class="block text-sm font-medium mb-2">Ngày sinh *</label><input type="date" id="studentBirthdate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('addStudentModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Thêm</button></div></form></div></div>
    <div id="editStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Chỉnh Sửa Thông Tin</h3><button onclick="closeModal('editStudentModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="editStudentForm" onsubmit="updateStudent(event)"><input type="hidden" id="editStudentIndex"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">Họ và tên *</label><input type="text" id="editStudentName" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Số báo danh *</label><input type="text" id="editStudentId" required class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-sm font-medium mb-2">Giới tính *</label><select id="editStudentGender" required class="w-full border rounded-lg px-3 py-2"><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div><div><label class="block text-sm font-medium mb-2">Ngày sinh *</label><input type="date" id="editStudentBirthdate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('editStudentModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Cập Nhật</button></div></form></div></div>
    <div id="addGradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Thêm/Sửa Điểm</h3><button onclick="closeModal('addGradeModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addGradeForm" onsubmit="addGrade(event)"><input type="hidden" id="gradeStudentId"><input type="hidden" id="gradeSubject"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">Điểm số mới *</label><input type="number" id="gradeValue" min="0" max="10" step="0.1" required class="w-full border rounded-lg px-3 py-2" placeholder="0.0 - 10.0"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addGradeModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Thêm Điểm</button></div></form></div></div>
    <div id="bulkGradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Nhập Điểm Hàng Loạt</h3><button onclick="closeModal('bulkGradeModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Học Sinh</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm Mới</th></tr></thead><tbody id="bulkGradeTableBody" class="divide-y divide-gray-200"></tbody></table></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('bulkGradeModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button onclick="saveBulkGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Lưu Tất Cả</button></div></div></div>
    <div id="addRewardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-green-700"><i class="fas fa-trophy mr-2"></i>Thêm Khen Thưởng</h3><button onclick="closeModal('addRewardModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addRewardForm" onsubmit="addReward(event)"><input type="hidden" id="rewardStudentId"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">Nội dung khen thưởng *</label><input type="text" id="rewardDescription" required class="w-full border rounded-lg px-3 py-2" placeholder="VD: Đạt điểm 10 môn Toán"></div><div><label class="block text-sm font-medium mb-2">Điểm cộng *</label><input type="number" id="rewardPoints" step="0.5" min="0" max="2" value="1" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addRewardModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Thêm</button></div></form></div></div>
    <div id="addViolationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Ghi Nhận Vi Phạm</h3><button onclick="closeModal('addViolationModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addViolationForm" onsubmit="addViolation(event)"><input type="hidden" id="violationStudentId"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">Nội dung vi phạm *</label><input type="text" id="violationDescription" required class="w-full border rounded-lg px-3 py-2" placeholder="VD: Đi học muộn"></div><div><label class="block text-sm font-medium mb-2">Điểm trừ *</label><input type="number" id="violationPoints" step="0.5" min="0.5" max="3" value="1" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addViolationModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Ghi nhận</button></div></form></div></div>
    <div id="addCommLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Thêm Nhật Ký Liên Lạc</h3><button onclick="closeModal('addCommLogModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><form id="addCommLogForm" onsubmit="addCommLog(event)"><div class="space-y-4"><div><label class="block text-sm font-medium mb-2">Học sinh *</label><select id="commStudentSelect" required class="w-full border rounded-lg px-3 py-2"></select></div><div><label class="block text-sm font-medium mb-2">Nội dung *</label><textarea id="commContent" required class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="VD: Trao đổi với phụ huynh về tình hình học tập..."></textarea></div><div><label class="block text-sm font-medium mb-2">Ngày liên lạc</label><input type="date" id="commDate" required class="w-full border rounded-lg px-3 py-2"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('addCommLogModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Lưu</button></div></form></div></div>
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 max-w-sm mx-4"><h3 class="text-lg font-semibold mb-4">Xác nhận</h3><p id="confirmationMessage" class="text-gray-600 mb-6"></p><div class="flex justify-end space-x-2"><button id="cancelButton" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Hủy</button><button id="confirmButton" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Xác nhận</button></div></div></div>
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-white rounded-lg p-6 w-full max-w-md mx-4"><h3 class="text-lg font-semibold mb-4">Nhập từ Excel</h3><p class="text-gray-600 mb-4">Chức năng này đang được phát triển.</p><div class="flex justify-end"><button onclick="closeModal('importModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Đóng</button></div></div></div>
    
    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 success-animation"><div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span id="successMessage"></span></div></div>

    <script>
        /* =======================
         *  A) API CONFIG & HELPERS
         * ======================= */
        // TODO: DÁN URL Web App Apps Script của thầy vào đây:
        const BASE_URL = 'https://script.google.com/macros/s/AKfycbxL89P-bQ79IHBwFk0ELgKmw36kQ18F1yHZMMEo5GVBKZYEAf1PRnC1gEq8wJ2-dIm1/exec';
        // Nếu có dùng token trong Code.gs thì đặt giống nhau; nếu không dùng, để chuỗi rỗng ''
        const API_TOKEN = 'changeme-optional';

        async function apiGet(action, params = {}) {
            const q = new URLSearchParams({ action, token: API_TOKEN, ...params });
            const res = await fetch(`${BASE_URL}?${q.toString()}`);
            return res.json();
        }
        async function apiPost(action, payload = {}) {
            const res = await fetch(BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, token: API_TOKEN, ...payload })
            });
            return res.json();
        }

        async function loadStudentsFromSheet() {
            try {
                const resp = await apiGet('getStudents');
                if (resp.ok && resp.data && Array.isArray(resp.data.students)) {
                    studentsData = resp.data.students;
                    filteredStudents = [...studentsData];
                } else {
                    showSuccessToast('Không tải được dữ liệu từ Sheets. Dùng dữ liệu mẫu.');
                }
            } catch (e) {
                console.error(e);
                showSuccessToast('Lỗi kết nối Sheets. Dùng dữ liệu mẫu.');
            }
        }

        // --- DATA (mẫu; sẽ bị thay bởi Sheets nếu load thành công) ---
        let studentsData = [
            { id: 1, name: 'Nguyễn Văn An', studentId: 'HS001', birthdate: '2008-03-15', gender: 'Nam', grades: { math: [8.5, 9], literature: [8], english: [7.5], physics: [8], chemistry: [7.5] }, disciplineScore: 9.5, violations: [{ desc: 'Đi muộn', points: 0.5 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 2, name: 'Trần Thị Bình', studentId: 'HS002', birthdate: '2008-07-22', gender: 'Nữ', grades: { math: [7], literature: [8], english: [6.5], physics: [7], chemistry: [6.5] }, disciplineScore: 8, violations: [{ desc: 'Không làm BTVN', points: 1 }, { desc: 'Nói chuyện riêng', points: 1 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'absent_unexcused' }, communication: [] },
            { id: 3, name: 'Lê Văn Cường', studentId: 'HS003', birthdate: '2008-11-10', gender: 'Nam', grades: { math: [9, 9.5], literature: [8.5], english: [8], physics: [9], chemistry: [8.5] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'Học sinh xuất sắc', points: 1 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 4, name: 'Phạm Thị Dung', studentId: 'HS004', birthdate: '2008-09-05', gender: 'Nữ', grades: { math: [8], literature: [9], english: [7.8], physics: [7.5], chemistry: [8.2] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'Tích cực phát biểu', points: 1 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 5, name: 'Hoàng Văn Em', studentId: 'HS005', birthdate: '2008-12-18', gender: 'Nam', grades: { math: [6.5], literature: [7.5], english: [6], physics: [6.8], chemistry: [6.5] }, disciplineScore: 9, violations: [{ desc: 'Đi muộn', points: 1 }], rewards: [], attendance: { '2025-05-01': 'late', '2025-05-02': 'present' }, communication: [] },
            { id: 6, name: 'Vũ Thị Giang', studentId: 'HS006', birthdate: '2008-04-30', gender: 'Nữ', grades: { math: [9.2, 9.5], literature: [8.8], english: [8.5], physics: [9], chemistry: [9.1] }, disciplineScore: 10, violations: [], rewards: [{ desc: 'Giải nhất thi HSG', points: 2 }], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 7, name: 'Đỗ Văn Hùng', studentId: 'HS007', birthdate: '2008-06-12', gender: 'Nam', grades: { math: [5.5], literature: [6], english: [4.5], physics: [5], chemistry: [5.2] }, disciplineScore: 6.5, violations: [{ desc: 'Nghỉ không phép', points: 2 }, { desc: 'Gây mất trật tự', points: 1.5 }], rewards: [], attendance: { '2025-05-01': 'absent_unexcused', '2025-05-02': 'absent_unexcused' }, communication: [] },
            { id: 8, name: 'Bùi Thị Hương', studentId: 'HS008', birthdate: '2008-08-25', gender: 'Nữ', grades: { math: [7.8], literature: [8.5], english: [7.2], physics: [7.5], chemistry: [7.8] }, disciplineScore: 10, violations: [], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] },
            { id: 9, name: 'Lý Văn Khánh', studentId: 'HS009', birthdate: '2008-01-08', gender: 'Nam', grades: { math: [8.8], literature: [8.2], english: [8], physics: [8.5], chemistry: [8.3] }, disciplineScore: 9.5, violations: [], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'absent_excused' }, communication: [] },
            { id: 10, name: 'Ngô Thị Linh', studentId: 'HS010', birthdate: '2008-10-14', gender: 'Nữ', grades: { math: [6.8], literature: [7.5], english: [6.5], physics: [6.8], chemistry: [7] }, disciplineScore: 9, violations: [{ desc: 'Quên đồng phục', points: 1 }], rewards: [], attendance: { '2025-05-01': 'present', '2025-05-02': 'present' }, communication: [] }
        ];
        const subjectMap = { math: 'To
